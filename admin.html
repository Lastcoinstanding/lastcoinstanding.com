<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Last Coin Standing â€” CMS</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

:root {
  --btc-orange: #e07800;
  --btc-orange-light: #fff3e0;
  --fiat-steel: #4a5568;
  --fiat-light: #e8eaed;
  --bg-page: #f5f5f5;
  --bg-white: #ffffff;
  --bg-card: #ffffff;
  --border: #d0d0d0;
  --border-light: #e5e5e5;
  --text: #1a1a1a;
  --text-muted: #555;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', -apple-system, sans-serif;
  background: var(--bg-page);
  color: var(--text);
  min-height: 100vh;
  font-size: 16px;
}

header {
  background: var(--bg-white);
  border-bottom: 2px solid var(--border);
  padding: 20px 28px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 12px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

header h1 { font-size: 1.5rem; font-weight: 700; color: var(--btc-orange); }
header h1 span { color: var(--text-muted); font-weight: 400; }

.header-actions { display: flex; gap: 12px; flex-wrap: wrap; }

.btn {
  padding: 12px 24px;
  border-radius: 6px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: all 0.2s;
}

.btn-secondary { background: var(--bg-white); color: var(--text); border: 2px solid var(--border); }
.btn-secondary:hover { background: var(--bg-page); border-color: #bbb; }
.btn-success { background: #2a7d2a; color: #fff; }
.btn-success:hover { background: #3a9d3a; }

.info-box {
  background: var(--btc-orange-light);
  border: 2px solid var(--btc-orange);
  border-radius: 8px;
  padding: 20px 24px;
  margin: 28px;
  margin-bottom: 0;
}

.info-box h3 { color: var(--btc-orange); font-size: 1.1rem; margin-bottom: 10px; }
.info-box ol { color: var(--text); font-size: 1rem; line-height: 2; margin-left: 24px; margin-top: 10px; }
.info-box a { color: var(--btc-orange); }

/* â•â•â• PAGE SELECTOR â•â•â• */
.page-selector {
  display: flex;
  gap: 0;
  margin-bottom: 28px;
  border-radius: 10px;
  overflow: hidden;
  border: 2px solid var(--border);
  background: var(--bg-white);
}

.page-tab {
  flex: 1;
  padding: 16px 24px;
  font-weight: 600;
  font-size: 1.05rem;
  cursor: pointer;
  background: var(--bg-white);
  color: var(--text-muted);
  transition: all 0.2s;
  text-align: center;
  border: none;
  border-right: 1px solid var(--border-light);
}

.page-tab:last-child { border-right: none; }
.page-tab:hover { background: var(--bg-page); }
.page-tab.active { background: var(--btc-orange-light); color: var(--btc-orange); font-weight: 700; }

.page-tab .page-tab-sub {
  display: block;
  font-size: 0.8rem;
  font-weight: 400;
  color: var(--text-muted);
  margin-top: 4px;
}

.page-tab.active .page-tab-sub { color: var(--btc-orange); opacity: 0.7; }

/* â•â•â• EDITOR â•â•â• */
.editor-panel { padding: 28px; max-width: 1400px; margin: 0 auto; }
.tree-selector { display: flex; gap: 12px; margin-bottom: 28px; }

.tree-tab {
  padding: 14px 28px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 1.1rem;
  cursor: pointer;
  border: 2px solid var(--border);
  background: var(--bg-white);
  color: var(--text-muted);
  transition: all 0.2s;
}

.tree-tab:hover { background: var(--bg-page); }
.tree-tab.active.btc { background: var(--btc-orange-light); border-color: var(--btc-orange); color: var(--btc-orange); }
.tree-tab.active.fiat { background: var(--fiat-light); border-color: var(--fiat-steel); color: var(--fiat-steel); }

.tree-settings {
  background: var(--bg-white);
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 24px;
  border: 2px solid var(--border);
}

.tree-settings h3 { font-size: 1rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 16px; }
.settings-row { display: flex; gap: 20px; flex-wrap: wrap; }
.settings-row + .settings-row { margin-top: 16px; }
.setting-field { flex: 1; min-width: 200px; }
.setting-field label { display: block; font-size: 0.95rem; color: var(--text-muted); margin-bottom: 8px; font-weight: 500; }
.setting-field input, .setting-field textarea {
  width: 100%;
  background: var(--bg-white);
  border: 2px solid var(--border);
  border-radius: 6px;
  padding: 12px 14px;
  color: var(--text);
  font-size: 1.1rem;
  font-family: inherit;
  resize: vertical;
}
.setting-field input:focus, .setting-field textarea:focus { outline: none; border-color: var(--btc-orange); }
.setting-field textarea { min-height: 80px; line-height: 1.6; }

/* â•â•â• CLUSTER / WORD TABLE â•â•â• */
.cluster-section {
  background: var(--bg-white);
  border-radius: 12px;
  margin-bottom: 24px;
  overflow: hidden;
  border: 2px solid var(--border);
}

.cluster-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 18px 24px;
  background: var(--bg-page);
  border-bottom: 2px solid var(--border);
  cursor: pointer;
}

.cluster-header:hover { background: #eaeaea; }
.cluster-header-left { display: flex; align-items: center; gap: 16px; }

.cluster-name-input {
  background: transparent;
  border: none;
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--btc-orange);
  width: 220px;
}

.cluster-name-input:focus { outline: none; border-bottom: 2px solid var(--btc-orange); }
.fiat-view .cluster-name-input { color: var(--fiat-steel); }
.fiat-view .cluster-name-input:focus { border-bottom-color: var(--fiat-steel); }

.word-count { font-size: 0.9rem; color: var(--text-muted); background: var(--bg-white); padding: 6px 12px; border-radius: 12px; border: 1px solid var(--border); }
.cluster-header-right { display: flex; align-items: center; gap: 10px; }

.delete-btn {
  background: none;
  border: 1px solid #ccc;
  color: #666;
  cursor: pointer;
  padding: 8px 14px;
  font-size: 0.95rem;
  border-radius: 4px;
}
.delete-btn:hover { background: #fee; border-color: #e55; color: #c33; }

.collapse-toggle { color: var(--text-muted); font-size: 1.4rem; transition: transform 0.2s; padding: 4px; }
.cluster-section.collapsed .collapse-toggle { transform: rotate(-90deg); }
.cluster-section.collapsed .cluster-content { display: none; }
.cluster-content { padding: 20px; overflow-x: auto; }

.word-table { width: 100%; border-collapse: collapse; min-width: 950px; }
.word-table th {
  text-align: left;
  padding: 14px 14px;
  font-size: 0.9rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-muted);
  border-bottom: 2px solid var(--border);
  background: var(--bg-page);
}

.word-table td { padding: 12px 14px; vertical-align: top; border-bottom: 1px solid var(--border-light); }
.word-table tr:last-child td { border-bottom: none; }

.word-table input, .word-table textarea {
  width: 100%;
  background: var(--bg-white);
  border: 2px solid var(--border);
  border-radius: 6px;
  padding: 12px 14px;
  color: var(--text);
  font-family: inherit;
  font-size: 1.05rem;
  line-height: 1.6;
  resize: vertical;
}

.word-table input:focus, .word-table textarea:focus { outline: none; border-color: var(--btc-orange); background: #fffcf5; }
.fiat-view .word-table input:focus, .fiat-view .word-table textarea:focus { border-color: var(--fiat-steel); background: #f8f9fa; }
.word-table .word-input { font-weight: 600; font-size: 1.1rem; }
.word-table textarea { min-height: 200px; }
.word-table .syn-input { font-size: 1rem; color: var(--text); }

.col-word { width: 120px; min-width: 120px; }
.col-desc { width: 200px; min-width: 170px; }
.col-insight { width: 240px; min-width: 200px; }
.col-contrast { width: 240px; min-width: 200px; }
.col-syn { width: 130px; min-width: 110px; }
.col-actions { width: 50px; min-width: 50px; }

.word-table .insight-input,
.word-table .contrast-input {
  min-height: 280px;
  font-size: 1.05rem;
  line-height: 1.6;
}

.word-table .delete-btn { padding: 8px 12px; font-size: 1.2rem; }

.add-btn {
  padding: 14px 20px;
  background: var(--bg-page);
  border: 2px dashed var(--border);
  border-radius: 8px;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 1rem;
  font-weight: 500;
  width: 100%;
  margin-top: 16px;
}
.add-btn:hover { background: #e8e8e8; color: var(--text); border-color: #bbb; }

/* â•â•â• CONCEPT CARDS (Flower editor) â•â•â• */
.concept-card {
  background: var(--bg-white);
  border-radius: 12px;
  margin-bottom: 20px;
  border: 2px solid var(--border);
  overflow: hidden;
}

.concept-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 24px;
  background: var(--bg-page);
  border-bottom: 2px solid var(--border);
  cursor: pointer;
}
.concept-card-header:hover { background: #eaeaea; }
.concept-card-header-left { display: flex; align-items: center; gap: 16px; }

.ring-badge {
  font-size: 0.75rem;
  font-weight: 600;
  padding: 4px 10px;
  border-radius: 10px;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  white-space: nowrap;
}
.ring-badge.ring-0 { background: var(--btc-orange-light); color: var(--btc-orange); }
.ring-badge.ring-1 { background: #e0f2fe; color: #0369a1; }
.ring-badge.ring-2 { background: #f3e8ff; color: #7c3aed; }

.concept-label-input {
  background: transparent;
  border: none;
  font-size: 1.2rem;
  font-weight: 700;
  color: var(--text);
  width: 250px;
}
.concept-label-input:focus { outline: none; border-bottom: 2px solid var(--btc-orange); }

.concept-card-header-right { display: flex; align-items: center; gap: 10px; }
.concept-card.collapsed .concept-card-body { display: none; }
.concept-card.collapsed .collapse-toggle { transform: rotate(-90deg); }

.concept-card-body {
  padding: 24px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.concept-field { display: flex; flex-direction: column; }
.concept-field.full-width { grid-column: 1 / -1; }
.concept-field label {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.04em;
  margin-bottom: 8px;
}

.concept-field input, .concept-field textarea, .concept-field select {
  width: 100%;
  background: var(--bg-white);
  border: 2px solid var(--border);
  border-radius: 6px;
  padding: 12px 14px;
  color: var(--text);
  font-family: inherit;
  font-size: 1.05rem;
  line-height: 1.6;
  resize: vertical;
}
.concept-field input:focus, .concept-field textarea:focus, .concept-field select:focus { outline: none; border-color: var(--btc-orange); background: #fffcf5; }
.concept-field textarea { min-height: 140px; }

/* â•â•â• TOAST / MODAL / RESPONSIVE â•â•â• */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: var(--bg-white);
  color: var(--text);
  padding: 16px 24px;
  border-radius: 8px;
  border: 2px solid var(--border);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  font-size: 1rem;
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.3s;
  z-index: 1001;
}
.toast.visible { opacity: 1; transform: translateY(0); }
.toast.success { border-color: #4a4; background: #e8f5e9; color: #2e7d32; }

.file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
.file-input-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }

.modal-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex; justify-content: center; align-items: center;
  z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.2s;
}
.modal-overlay.visible { opacity: 1; visibility: visible; }

.modal {
  background: var(--bg-white); border-radius: 12px; width: 90%; max-width: 520px;
  border: 2px solid var(--border); box-shadow: 0 8px 32px rgba(0,0,0,0.2);
}
.modal-header { padding: 24px 28px; border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.modal-header h2 { font-size: 1.3rem; color: var(--text); }
.modal-close { background: none; border: none; color: var(--text-muted); font-size: 1.8rem; cursor: pointer; }
.modal-close:hover { color: var(--text); }
.modal-body { padding: 28px; }
.modal-body p { color: var(--text); font-size: 1rem; line-height: 1.7; margin-bottom: 18px; }
.modal-body code { background: var(--bg-page); padding: 3px 8px; border-radius: 4px; font-size: 0.95rem; border: 1px solid var(--border); }
.modal-body input { width: 100%; background: var(--bg-white); border: 2px solid var(--border); border-radius: 6px; padding: 14px 16px; color: var(--text); font-size: 1.05rem; margin-bottom: 10px; }
.modal-body input:focus { outline: none; border-color: var(--btc-orange); }
.modal-body .hint { font-size: 0.95rem; color: var(--text-muted); line-height: 1.6; }
.modal-body .hint a { color: var(--btc-orange); }
.modal-footer { padding: 20px 28px; border-top: 2px solid var(--border); display: flex; justify-content: flex-end; gap: 14px; }

.publishing { pointer-events: none; opacity: 0.7; }
.editor-section { display: none; }
.editor-section.active { display: block; }

@media (max-width: 768px) {
  header { padding: 14px 18px; }
  header h1 { font-size: 1.2rem; }
  .btn { padding: 10px 16px; font-size: 0.95rem; }
  .editor-panel { padding: 18px; }
  .info-box { margin: 18px; }
  .col-syn, .col-insight, .col-contrast { display: none; }
  .word-table { min-width: unset; }
  .col-desc { width: auto; }
  .page-tab { padding: 12px 14px; font-size: 0.95rem; }
  .page-tab .page-tab-sub { font-size: 0.72rem; }
  .concept-card-body { grid-template-columns: 1fr; }
}

@media (max-width: 1200px) and (min-width: 769px) {
  .col-insight, .col-contrast { width: 180px; min-width: 160px; }
  .word-table .insight-input,
  .word-table .contrast-input { min-height: 100px; }
}
</style>
</head>
<body>

<header>
  <h1>Last Coin Standing <span>CMS</span></h1>
  <div class="header-actions">
    <div class="file-input-wrapper">
      <button class="btn btn-secondary">Load JSON</button>
      <input type="file" id="file-input" accept=".json" onchange="loadFile(event)">
    </div>
    <button class="btn btn-secondary" onclick="downloadCurrentJSON()">â¬‡ Download</button>
    <button class="btn btn-success" onclick="publishToGitHub()">ğŸš€ Publish</button>
  </div>
</header>

<div class="info-box">
  <h3>How to Update Your Site</h3>
  <ol>
    <li>Choose which page to edit below, then make your changes</li>
    <li>Click <strong>"ğŸš€ Publish"</strong> to push changes live</li>
    <li>First time? You'll need to enter your <a href="#" onclick="showTokenHelp(); return false;">GitHub token</a> (one-time setup)</li>
  </ol>
</div>

<div class="editor-panel">
  <!-- PAGE SELECTOR -->
  <div class="page-selector">
    <div class="page-tab active" onclick="switchPage('trees')">
      The Money Trees
      <span class="page-tab-sub">data.json</span>
    </div>
    <div class="page-tab" onclick="switchPage('flower')">
      Bitcoin Dimensions
      <span class="page-tab-sub">concepts.json</span>
    </div>
  </div>

  <!-- MONEY TREES EDITOR -->
  <div class="editor-section active" id="section-trees">
    <div class="tree-selector">
      <div class="tree-tab btc active" onclick="switchTree('btc')">Bitcoin Tree</div>
      <div class="tree-tab fiat" onclick="switchTree('fiat')">Fiat Tree</div>
    </div>
    <div id="tree-settings"></div>
    <div id="editor-content"></div>
  </div>

  <!-- FLOWER OF LIFE EDITOR -->
  <div class="editor-section" id="section-flower">
    <div id="flower-settings"></div>
    <div id="flower-content"></div>
  </div>
</div>

<!-- TOKEN MODAL -->
<div class="modal-overlay" id="token-modal">
  <div class="modal">
    <div class="modal-header">
      <h2>GitHub Token Setup</h2>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <p>To publish directly, you need a GitHub Personal Access Token. This is stored only in your browser.</p>
      <input type="password" id="token-input" placeholder="Paste your GitHub token here">
      <p class="hint">
        <a href="https://github.com/settings/tokens/new?description=Last%20Coin%20Standing%20CMS&scopes=repo" target="_blank">â†’ Click here to create a token</a><br>
        Select <code>repo</code> scope, then copy the token.
      </p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-success" onclick="saveTokenAndPublish()">Save & Publish</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentPage = 'trees';
let currentTree = 'btc';

let treesData = {
  "bitcoin": { "title": "Bitcoin", "subtitle": "Sound money", "clusters": [{ "name": "Core", "words": [{ "word": "Freedom", "description": "Default.", "synonyms": [] }] }] },
  "fiat": { "title": "Fiat", "subtitle": "Broken money", "clusters": [{ "name": "Core", "words": [{ "word": "Compulsory", "description": "Default.", "synonyms": [] }] }] }
};

let flowerData = {
  "meta": { "title": "What Bitcoin Is", "subtitle": "", "completionTitle": "", "completionDesc": "", "completionRelation": "", "panelIntro": "", "panelIntroSecondary": "", "panelCta": "Click any circle to begin" },
  "concepts": [{ "id": "bitcoin", "label": "Bitcoin", "ring": 0, "position": "center", "tag": "The Foundation", "desc": "", "relation": "" }]
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function showToast(msg, type = '') {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = 'toast visible ' + type;
  setTimeout(() => toast.classList.remove('visible'), 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAGE SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchPage(page) {
  currentPage = page;
  document.querySelectorAll('.page-tab').forEach((tab, i) => {
    tab.classList.toggle('active', (i === 0 && page === 'trees') || (i === 1 && page === 'flower'));
  });
  document.getElementById('section-trees').classList.toggle('active', page === 'trees');
  document.getElementById('section-flower').classList.toggle('active', page === 'flower');
  if (page === 'flower') renderFlowerEditor();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MONEY TREES EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTreeEditor() {
  const treeKey = currentTree === 'btc' ? 'bitcoin' : 'fiat';
  const td = treesData[treeKey];
  const container = document.getElementById('editor-content');
  const settings = document.getElementById('tree-settings');
  container.className = currentTree === 'fiat' ? 'fiat-view' : '';

  settings.innerHTML = `
    <div class="tree-settings">
      <h3>Tree Settings</h3>
      <div class="settings-row">
        <div class="setting-field"><label>Title</label><input type="text" value="${escapeHtml(td.title)}" onchange="updateTreeSetting('title', this.value)"></div>
        <div class="setting-field"><label>Subtitle</label><input type="text" value="${escapeHtml(td.subtitle)}" onchange="updateTreeSetting('subtitle', this.value)"></div>
      </div>
    </div>`;

  let html = '';
  td.clusters.forEach((cluster, ci) => {
    html += `
      <div class="cluster-section" id="cluster-${ci}">
        <div class="cluster-header" onclick="toggleEl('cluster-${ci}')">
          <div class="cluster-header-left">
            <input type="text" class="cluster-name-input" value="${escapeHtml(cluster.name)}" onclick="event.stopPropagation()" onchange="updateClusterName(${ci}, this.value)">
            <span class="word-count">${cluster.words.length} words</span>
          </div>
          <div class="cluster-header-right">
            <button class="delete-btn" onclick="event.stopPropagation(); deleteCluster(${ci})">Delete</button>
            <span class="collapse-toggle">â–¼</span>
          </div>
        </div>
        <div class="cluster-content">
          <table class="word-table">
            <thead><tr>
              <th class="col-word">Word</th><th class="col-desc">Description</th>
              <th class="col-insight">Deeper Insight</th><th class="col-contrast">Contrast</th>
              <th class="col-syn">Synonyms</th><th class="col-actions"></th>
            </tr></thead>
            <tbody>
              ${cluster.words.map((w, wi) => `<tr>
                <td><input type="text" class="word-input" value="${escapeHtml(w.word)}" onchange="updateWord(${ci},${wi},'word',this.value)"></td>
                <td><textarea onchange="updateWord(${ci},${wi},'description',this.value)">${escapeHtml(w.description||'')}</textarea></td>
                <td><textarea class="insight-input" onchange="updateWord(${ci},${wi},'deeperInsight',this.value)" placeholder="Extended insight...">${escapeHtml(w.deeperInsight||'')}</textarea></td>
                <td><textarea class="contrast-input" onchange="updateWord(${ci},${wi},'contrast',this.value)" placeholder="Contrasting perspective...">${escapeHtml(w.contrast||'')}</textarea></td>
                <td><input type="text" class="syn-input" value="${(w.synonyms||[]).join(', ')}" onchange="updateSynonyms(${ci},${wi},this.value)" placeholder="comma separated"></td>
                <td><button class="delete-btn" onclick="deleteWord(${ci},${wi})" title="Delete">Ã—</button></td>
              </tr>`).join('')}
            </tbody>
          </table>
          <button class="add-btn" onclick="addWord(${ci})">+ Add Word</button>
        </div>
      </div>`;
  });
  html += `<button class="add-btn" onclick="addCluster()">+ Add New Cluster</button>`;
  container.innerHTML = html;
}

function switchTree(tree) {
  currentTree = tree;
  document.querySelectorAll('.tree-tab').forEach(tab => tab.classList.toggle('active', tab.classList.contains(tree)));
  renderTreeEditor();
}

function toggleEl(id) { document.getElementById(id).classList.toggle('collapsed'); }

function updateTreeSetting(f, v) { treesData[currentTree === 'btc' ? 'bitcoin' : 'fiat'][f] = v; }
function updateClusterName(ci, v) { treesData[currentTree === 'btc' ? 'bitcoin' : 'fiat'].clusters[ci].name = v; }
function updateWord(ci, wi, f, v) { treesData[currentTree === 'btc' ? 'bitcoin' : 'fiat'].clusters[ci].words[wi][f] = v; }
function updateSynonyms(ci, wi, v) { treesData[currentTree === 'btc' ? 'bitcoin' : 'fiat'].clusters[ci].words[wi].synonyms = v.split(',').map(s=>s.trim()).filter(s=>s); }

function addWord(ci) {
  treesData[currentTree === 'btc' ? 'bitcoin' : 'fiat'].clusters[ci].words.push({ word: "New Word", description: "", deeperInsight: "", contrast: "", synonyms: [] });
  renderTreeEditor();
}

function deleteWord(ci, wi) {
  const k = currentTree === 'btc' ? 'bitcoin' : 'fiat';
  if (treesData[k].clusters[ci].words.length > 1) { treesData[k].clusters[ci].words.splice(wi, 1); renderTreeEditor(); }
  else showToast('Cannot delete the last word');
}

function addCluster() {
  treesData[currentTree === 'btc' ? 'bitcoin' : 'fiat'].clusters.push({ name: "New Cluster", words: [{ word: "Word", description: "", deeperInsight: "", contrast: "", synonyms: [] }] });
  renderTreeEditor();
}

function deleteCluster(ci) {
  const k = currentTree === 'btc' ? 'bitcoin' : 'fiat';
  if (treesData[k].clusters.length > 1) { if (confirm(`Delete "${treesData[k].clusters[ci].name}"?`)) { treesData[k].clusters.splice(ci, 1); renderTreeEditor(); } }
  else showToast('Cannot delete the last cluster');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FLOWER OF LIFE EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFlowerEditor() {
  const s = document.getElementById('flower-settings');
  const c = document.getElementById('flower-content');
  const m = flowerData.meta;

  s.innerHTML = `
    <div class="tree-settings">
      <h3>Page Settings</h3>
      <div class="settings-row">
        <div class="setting-field"><label>Page Title</label><input type="text" value="${escapeHtml(m.title)}" onchange="flowerData.meta.title=this.value"></div>
        <div class="setting-field"><label>Subtitle</label><input type="text" value="${escapeHtml(m.subtitle)}" onchange="flowerData.meta.subtitle=this.value"></div>
      </div>
      <div class="settings-row">
        <div class="setting-field"><label>Panel Intro</label><textarea onchange="flowerData.meta.panelIntro=this.value">${escapeHtml(m.panelIntro)}</textarea></div>
        <div class="setting-field"><label>Panel Secondary</label><textarea onchange="flowerData.meta.panelIntroSecondary=this.value">${escapeHtml(m.panelIntroSecondary)}</textarea></div>
      </div>
      <div class="settings-row">
        <div class="setting-field"><label>Panel CTA</label><input type="text" value="${escapeHtml(m.panelCta)}" onchange="flowerData.meta.panelCta=this.value"></div>
        <div class="setting-field"><label>Completion Title</label><input type="text" value="${escapeHtml(m.completionTitle)}" onchange="flowerData.meta.completionTitle=this.value"></div>
      </div>
      <div class="settings-row">
        <div class="setting-field"><label>Completion Description</label><textarea onchange="flowerData.meta.completionDesc=this.value">${escapeHtml(m.completionDesc)}</textarea></div>
        <div class="setting-field"><label>Completion Relation (HTML ok)</label><textarea onchange="flowerData.meta.completionRelation=this.value">${escapeHtml(m.completionRelation)}</textarea></div>
      </div>
    </div>`;

  const ringLabels = { 0: 'Center', 1: 'Core Property', 2: 'Emergent Property' };
  let html = `<h3 style="font-size:1rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:16px;">Concepts (${flowerData.concepts.length})</h3>`;

  flowerData.concepts.forEach((con, i) => {
    html += `
      <div class="concept-card" id="concept-${i}">
        <div class="concept-card-header" onclick="toggleEl('concept-${i}')">
          <div class="concept-card-header-left">
            <span class="ring-badge ring-${con.ring}">${ringLabels[con.ring] || 'Ring '+con.ring}</span>
            <input type="text" class="concept-label-input" value="${escapeHtml(con.label)}" onclick="event.stopPropagation()" onchange="flowerData.concepts[${i}].label=this.value">
          </div>
          <div class="concept-card-header-right">
            <button class="delete-btn" onclick="event.stopPropagation(); deleteConcept(${i})">Delete</button>
            <span class="collapse-toggle">â–¼</span>
          </div>
        </div>
        <div class="concept-card-body">
          <div class="concept-field"><label>ID (unique key)</label><input type="text" value="${escapeHtml(con.id)}" onchange="flowerData.concepts[${i}].id=this.value"></div>
          <div class="concept-field"><label>Tag</label><input type="text" value="${escapeHtml(con.tag)}" onchange="flowerData.concepts[${i}].tag=this.value"></div>
          <div class="concept-field">
            <label>Ring</label>
            <select onchange="flowerData.concepts[${i}].ring=parseInt(this.value); renderFlowerEditor();">
              <option value="0" ${con.ring===0?'selected':''}>0 â€” Center</option>
              <option value="1" ${con.ring===1?'selected':''}>1 â€” Core Property</option>
              <option value="2" ${con.ring===2?'selected':''}>2 â€” Emergent Property</option>
            </select>
          </div>
          <div class="concept-field"><label>Position</label><input type="text" value="${escapeHtml(con.position)}" onchange="flowerData.concepts[${i}].position=this.value" placeholder="e.g. top, top-right, center"></div>
          <div class="concept-field full-width"><label>Description</label><textarea onchange="flowerData.concepts[${i}].desc=this.value">${escapeHtml(con.desc)}</textarea></div>
          <div class="concept-field full-width"><label>Relation (HTML ok â€” use &lt;strong&gt; for cross-references)</label><textarea onchange="flowerData.concepts[${i}].relation=this.value">${escapeHtml(con.relation)}</textarea></div>
        </div>
      </div>`;
  });

  html += `<button class="add-btn" onclick="addConcept()">+ Add New Concept</button>`;
  c.innerHTML = html;
}

function addConcept() {
  flowerData.concepts.push({ id: "new-concept", label: "New Concept", ring: 2, position: "top", tag: "Emergent Property", desc: "", relation: "" });
  renderFlowerEditor();
}

function deleteConcept(i) {
  if (flowerData.concepts.length > 1) { if (confirm(`Delete "${flowerData.concepts[i].label}"?`)) { flowerData.concepts.splice(i, 1); renderFlowerEditor(); } }
  else showToast('Cannot delete the last concept');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE I/O
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function downloadCurrentJSON() {
  const isFlower = currentPage === 'flower';
  const blob = new Blob([JSON.stringify(isFlower ? flowerData : treesData, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = isFlower ? 'concepts.json' : 'data.json';
  a.click();
  URL.revokeObjectURL(a.href);
  showToast(`${a.download} downloaded!`, 'success');
}

function loadFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const loaded = JSON.parse(e.target.result);
      if (loaded.bitcoin && loaded.fiat) {
        treesData = loaded; switchPage('trees'); renderTreeEditor();
        showToast('Loaded data.json (Money Trees)', 'success');
      } else if (loaded.meta && loaded.concepts) {
        flowerData = loaded; switchPage('flower'); renderFlowerEditor();
        showToast('Loaded concepts.json (Flower of Life)', 'success');
      } else { throw new Error('Unrecognized format'); }
    } catch (err) { showToast('Error: ' + err.message); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GITHUB PUBLISHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const REPO_OWNER = 'Lastcoinstanding';
const REPO_NAME = 'lastcoinstanding.com';

function getToken() { return localStorage.getItem('github_token'); }
function saveToken(t) { localStorage.setItem('github_token', t); }
function showTokenModal() { document.getElementById('token-modal').classList.add('visible'); document.getElementById('token-input').value = getToken() || ''; }
function closeModal() { document.getElementById('token-modal').classList.remove('visible'); }
function showTokenHelp() { showTokenModal(); }
function saveTokenAndPublish() {
  const t = document.getElementById('token-input').value.trim();
  if (!t) { showToast('Please enter a token'); return; }
  saveToken(t); closeModal(); publishToGitHub();
}

async function publishToGitHub() {
  const token = getToken();
  if (!token) { showTokenModal(); return; }

  const isFlower = currentPage === 'flower';
  const filePath = isFlower ? 'concepts.json' : 'data.json';
  const data = isFlower ? flowerData : treesData;
  const label = isFlower ? 'Flower of Life' : 'Money Trees';

  const btn = document.querySelector('.btn-success');
  const orig = btn.textContent;
  btn.textContent = 'â³ Publishing...';
  btn.classList.add('publishing');

  try {
    const getRes = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filePath}`, { headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' } });
    let sha = null;
    if (getRes.ok) sha = (await getRes.json()).sha;

    const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
    const putRes = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filePath}`, {
      method: 'PUT',
      headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: `Update ${label} content via CMS`, content, sha })
    });

    if (putRes.ok) showToast(`âœ“ ${label} published! Site updates in ~30s.`, 'success');
    else {
      const err = await putRes.json();
      if (putRes.status === 401) { localStorage.removeItem('github_token'); showToast('Token invalid or expired.'); showTokenModal(); }
      else showToast('Error: ' + (err.message || 'Failed'));
    }
  } catch (err) { showToast('Error: ' + err.message); }
  finally { btn.textContent = orig; btn.classList.remove('publishing'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT â€” load both JSON files
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  const loaded = [];
  try {
    const r = await fetch('data.json');
    if (r.ok) { const d = await r.json(); if (d.bitcoin && d.fiat) { treesData = d; loaded.push('data.json'); } }
  } catch(e) {}
  try {
    const r = await fetch('concepts.json');
    if (r.ok) { const d = await r.json(); if (d.meta && d.concepts) { flowerData = d; loaded.push('concepts.json'); } }
  } catch(e) {}

  renderTreeEditor();
  if (loaded.length) showToast('Loaded ' + loaded.join(' + '), 'success');
  else showToast('Using defaults â€” load your JSON files to edit', '');
}

init();
</script>
</body>
</html>
